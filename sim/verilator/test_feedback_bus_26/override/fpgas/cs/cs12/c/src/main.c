#include "dma.h"
#include "vmem.h"
#include "csr_control.h"
#include "vmalloc.h"
#include "circular_buffer.h"
#include "fill.h"
#include "ringbus.h"
#include "coarse_sync.h"
#include "atan.h"
#include "xvcordic.h"
#include "schedule.h"
#include "duplex_schedule.h"

// #include "flush_config_word_data.h"
// #include "fft_1024_3914.h"

#include "ringbus2_pre.h"
#include "ringbus2_post.h"
#include "nco_data.h"
#include "corrupt_dma.h"
#include "check_bootload.h"
#include "subtract_timers.h"
#include "trunk_types.h"
#include "copy_config.h"
#include "vmem_copy.h"
#include "eq_random_rotation.h"
#include "get_timer.h"
#include "self_sync.h"
#include "ook_modem.h"
#include "handle_generic_op.h"

#include "vmem_copy.h"
#include "iir.h"

#include <stdint.h>
#include <stdbool.h>
#include <stdlib.h> // for abs()

// #define ENABLE_TB_DEBUG

#ifndef ENABLE_TB_DEBUG
#define DISABLE_TB_DEBUG
#endif
#include "tb_debug.h"


#define FFT_SIZE (1024)
#define TRUNK_OFFSET (FFT_SIZE)


#define PING_PONG_BUFFER_SIZE (FFT_SIZE+TRUNK_LENGTH)
#define PING_PONG_DISABLE_OUTPUT

#include "ping_pong_driver.h"





#include "flush_config_word_data.h"
#include "fft_1024_3914_modular.h"


///////////////////////////////////////
//// for fine sync
#include "config_word_add_eq_00.h"
#include "config_word_add_eq_01.h"
#include "config_word_cmul_rx4_0f.h"
#include "config_word_cmul_rx4_00.h"
#include "config_word_cmul_eq_00.h"
#include "config_word_cmul_eq_0f.h"
#include "config_word_conj_eq_11.h"
#include "config_word_conj_eq_13.h"
#include "config_word_conj_eq_14.h"
#include "config_word_conj_eq_15.h"
#include "config_word_conj_eq_0f.h"
#include "config_word_conj_eq_0b.h"
#include "config_word_conj_rx4_0f.h"
#include "config_word_add_eq_00.h"
#include "config_word_add_rx4_00.h"
#include "config_word_add_rx4_01.h"
#include "config_word_add_rx4_02.h"
#include "config_word_add_rx4_03.h"
#include "config_word_sub_eq_00.h"
#include "config_word_magsquare_eq_00.h"


VMEM_SECTION unsigned int nco_data[1024] = {0};
// VMEM_SECTION unsigned int nco_data_common_phase[16]={0};
VMEM_SECTION unsigned int input_result[1024] = {0};
// VMEM_SECTION unsigned int output_result[1024] = {0};
// VMEM_SECTION unsigned int output_fine_sync[1024] = {0};

VMEM_SECTION unsigned int input_pilot_conjmul[144] = {0};
VMEM_SECTION unsigned int output_pilot_conjmul[64] = {0};

// VMEM_SECTION unsigned int output_common_phase[256] = {0};

VMEM_SECTION unsigned int permutation_memcopy[16] = {0xf000, 0xf000, 0xf000, 0xf000, 0xf000, 0xf000, 0xf000, 0xf000, 0xf000, 0xf000, 0xf000, 0xf000, 0xf000, 0xf000, 0xf000, 0xf000};
VMEM_SECTION unsigned int permutation_pilot_conjmul_0[16] = {0x0000, 0x1000, 0x2000, 0x3000, 0x4000, 0x5000, 0x6000, 0x7000, 0x9000, 0xa000, 0xb000, 0xc000, 0xd000, 0xe000, 0xf000, 0x0000};
VMEM_SECTION unsigned int permutation_pilot_conjmul_1[16] = {0x2000, 0x3000, 0x4000, 0x5000, 0x6000, 0x7000, 0x8000, 0xa000, 0xb000, 0xc000, 0xd000, 0xe000, 0xf000, 0x0000, 0x1000, 0x1000};
VMEM_SECTION unsigned int bank_address_pilot_conjmul_0[16] = {0x0, 0x1, 0x0, 0x1, 0x0, 0x1, 0x0, 0x1, 0x0, 0x1, 0x0, 0x1, 0x0, 0x1, 0x0, 0x1};
VMEM_SECTION unsigned int bank_address_pilot_conjmul_1[16] = {0x2, 0x1, 0x0, 0x1, 0x0, 0x1, 0x0, 0x1, 0x0, 0x1, 0x0, 0x1, 0x0, 0x1, 0x0, 0x1};
VMEM_SECTION unsigned int permutation_pilot_conjmul_add[16] = {0x0000, 0x3000, 0x6000, 0x9000, 0xd000, 0xd000, 0xd000, 0xe000, 0xe000, 0xe000, 0xf000, 0xf000, 0xf000, 0x0, 0x0, 0x0};
// VMEM_SECTION unsigned int bank_address_pilot_common_phase[16] = {0x2, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0, 0x0};

VMEM_SECTION unsigned int vmem_zeros[16];


VMEM_SECTION unsigned short variable_eq_rotate[32];
VMEM_SECTION unsigned short variable_r0_mul[32];
VMEM_SECTION unsigned short variable_r0_add[32];
VMEM_SECTION unsigned short variable_r1_mul[32];
VMEM_SECTION unsigned short variable_r1_add[32];
VMEM_SECTION unsigned short variable_eq_applied[32];

//VMEM_SECTION unsigned int EQ_data_default[1024] = {0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff, 0x7fff};
VMEM_SECTION unsigned int EQ_data_default[1024] = {0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff};

// VMEM_SECTION unsigned int EQ_data_pilot_frame[1024] = {0};
VMEM_SECTION unsigned int EQ_data_applied[1024] = {0};


// VMEM_SECTION unsigned int coeff_state[1024] = {0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000};
// VMEM_SECTION unsigned int coeff_new_measure[1024] = {0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff};

VMEM_SECTION unsigned int tx_eq_data_state[1024] = {0};

VMEM_SECTION unsigned int rx_coeff_state_one_row[16] = {0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000};
VMEM_SECTION unsigned int rx_coeff_new_measure_one_row[16] = {0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff};

VMEM_SECTION unsigned int tx_coeff_state_one_row[16] = {0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000, 0x2000};
VMEM_SECTION unsigned int tx_coeff_new_measure_one_row[16] = {0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff, 0x5fff};


unsigned int variable_eq_rotate_row;
unsigned int variable_r0_mul_row;
unsigned int variable_r0_add_row;
unsigned int variable_r1_mul_row;
unsigned int variable_r1_add_row;
unsigned int variable_eq_applied_row;

unsigned int sfo_correction_rx_flag = 0;
unsigned int sfo_shift_rx_amount = 14;

unsigned int EQ_data_rx_indi = 1;

VMEM_SECTION unsigned int rx_eq_for_data[1024] = {0};

// #define MA_SIZE 16
// #define MA_SIZE_LOG 4

int ring_flag=0;
// int sto_sfo_angle_flag = MA_SIZE;
// short sto_sfo_angle[MA_SIZE];
// unsigned int sto_sfo_angle_indi = 0;

// unsigned int sorted_array[MA_SIZE];
// unsigned int data_array[MA_SIZE];

unsigned int datapath_saturation_flag = 0;
unsigned int last_datapath_saturation_report = 0xffff0000; // should guarentee the first saturation gets reported
unsigned int last_datapath_underflow_report = 0xffff0000; // should guarentee the first saturation gets reported


unsigned int ook_subcarrier = 1003;
OOKDemod demod;

static uint32_t lifetime_32 = 4;
uint32_t do_debug_ota_frame = 0;
static uint32_t duplex_progress;
// static uint32_t duplex_mode;
duplex_timeslot_t duplex;       // set to our own mode

static uint32_t duplex_mode;

static uint32_t duplex_mode_rx;
duplex_timeslot_t duplex_rx;    // always set to rx mode

static uint32_t cooked_data_type = 2;
static unsigned dnr_extra = 0;

// static bool dplx_do_not_rotate = false;

unsigned int rx_eq_for_data_flag = 0;




bool rx_fft_coarse_flag = false;


#define FSM_STATE_IDLE (0)
#define FSM_STATE_DUPLEX_SYNC (1)
#define FSM_GOT_COUNTER_1 (2)
#define FSM_GOT_COUNTER_2 (3)
#define FSM_STATE_ADJUST (4)
#define FSM_DEBUG_RESULT (5)
#define FSM_STALL (99)

uint32_t duplex_state = 0;
uint32_t enter_duplex_sync = 0;

bool ook_counter_valid = false;
uint32_t ook_counter_delta = 0;

void fsm_notify_coarse_sync(void) {
    rx_fft_coarse_flag = true;
}

void fsm_notify_ook_counter(uint32_t counter) {
    ook_counter_delta = counter;
    ook_counter_valid = true;
}



///
/// Will send saturation ringbus to pc but with a rate limit
/// Should be setup so that the first saturation always sends
void saturation_report_slow(void) {
    unsigned now;
    CSR_READ(TIMER_VALUE, now);

    //                       calculates a-b
    const unsigned counter_delta = subtract_timers(now,last_datapath_saturation_report);

    if( counter_delta > 0x7698000 ) {
        last_datapath_saturation_report = now;
        ring_block_send_eth(RX_FINE_SYNC_OVERFLOW_PCCMD | 0); // could put timer value or OFDM frame here
    }
}

void underflow_report_slow(const unsigned int radio) {
    unsigned now;
    CSR_READ(TIMER_VALUE, now);

    //                       calculates a-b
    const unsigned counter_delta = subtract_timers(now,last_datapath_underflow_report);

    if( counter_delta > 0x7698000 ) {
        last_datapath_underflow_report = now;
        ring_block_send_eth(RX_FINE_SYNC_OVERFLOW_PCCMD | (1+radio)); // could put timer value or OFDM frame here
    }
}

unsigned int pre_sfo = 0;

/////////////////////////////////////////////////////////////////////////////////////
////////////// 4 gap
VMEM_SECTION unsigned int permutation_pilot_conjmul_0_trial_4_0[16] = {0x2000, 0x5000, 0x8000, 0xb000, 0xf000, 0x2000, 0x5000, 0x8000, 0xc000, 0xf000, 0x2000, 0x5000, 0x9000, 0xc000, 0xf000, 0x2000};
VMEM_SECTION unsigned int permutation_pilot_conjmul_1_trial_4_0[16] = {0x6000, 0x9000, 0xc000, 0x0000, 0x3000, 0x6000, 0x9000, 0xd000, 0x0000, 0x3000, 0x6000, 0xa000, 0xd000, 0x0000, 0x3000, 0x3000};
VMEM_SECTION unsigned int bank_address_pilot_conjmul_0_trial_4_0[16] = {0x2, 0x3, 0x0, 0x1, 0x2, 0x3, 0x0, 0x1, 0x2, 0x3, 0x0, 0x1, 0x2, 0x3, 0x0, 0x1};
VMEM_SECTION unsigned int bank_address_pilot_conjmul_1_trial_4_0[16] = {0x2, 0x3, 0x4, 0x1, 0x2, 0x3, 0x0, 0x1, 0x2, 0x3, 0x0, 0x1, 0x2, 0x3, 0x0, 0x1};

VMEM_SECTION unsigned int permutation_pilot_conjmul_add_trial_4_0[16] = {0x0000, 0x3000, 0x6000, 0x9000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000};


///////////////////////////////////////////////////////////////////////////////////////////
/////////////////////////////////////////////////////////////////////////////////////
//////////////// 4 gap
VMEM_SECTION unsigned int permutation_pilot_conjmul_0_trial_4_1[16] = {0x0000, 0x3000, 0x6000, 0x9000, 0xd000, 0x0000, 0x3000, 0x6000, 0xa000, 0xd000, 0x0000, 0x3000, 0x7000, 0xa000, 0xd000, 0x0000};
VMEM_SECTION unsigned int permutation_pilot_conjmul_1_trial_4_1[16] = {0x4000, 0x7000, 0xa000, 0xe000, 0x1000, 0x4000, 0x7000, 0xb000, 0xe000, 0x1000, 0x4000, 0x8000, 0xb000, 0xe000, 0x1000, 0x1000};
VMEM_SECTION unsigned int bank_address_pilot_conjmul_0_trial_4_1[16] = {0x0, 0x1, 0x2, 0x3, 0x0, 0x1, 0x2, 0x3, 0x0, 0x1, 0x2, 0x3, 0x0, 0x1, 0x2, 0x3};
VMEM_SECTION unsigned int bank_address_pilot_conjmul_1_trial_4_1[16] = {0x4, 0x1, 0x2, 0x3, 0x0, 0x1, 0x2, 0x3, 0x0, 0x1, 0x2, 0x3, 0x0, 0x1, 0x2, 0x3};

VMEM_SECTION unsigned int permutation_pilot_conjmul_add_trial_4_1[16] = {0x0000, 0x3000, 0x6000, 0x9000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000};




// threshold for underflow message, units are magnitude squared
const int64_t magnitude_underflow_thresh = (300*300);

// unsigned int one_pilot_observe = 0;
// unsigned int second_pilot_observe = 0;


// uint32_t debug_ota_sc = 1;



//////////////////////////////////////////////////////////


static VMEM_SECTION unsigned int garbage_vmem[16];
unsigned int garbage_row;


// When RX radio sends us a P frame, only 1/10 frames are valud
// We use a composite frame here
static VMEM_SECTION unsigned int duplex_composite_ul_pilot[FFT_SIZE];

unsigned int duplex_composite_ul_pilot_row;
unsigned int duplex_composite_ul_pilot_dma;
uint32_t enable_composite_ul_pilot = 1;


fft1024_cfg_t active_plan;

fft1024_cfg_t active_plan_2;

void setup_fft(void) {
  // fft_ptr[0] = (unsigned int)fft_mem_a;
  // fft_ptr[1] = (unsigned int)fft_mem_b;
  // mark_both_fft_empty();

  active_plan = get_fft1024_plan(0, 0);
  active_plan_2 = get_fft1024_plan(0, 0);
}


VMEM_SECTION unsigned int fft_mem_temp[1024+16];


#define MY_ASSERT(x) if(!(x)) { ring_block_send_eth(0xe0000000|__LINE__);}

unsigned times_worked = 0;

unsigned do_work(
                const unsigned int index,
                const unsigned int* const cpu_in,
                      unsigned int* const cpu_out
               ) {
    (void)index;
    (void)cpu_out;

    // if( times_worked == 2 ) {
    //     ring_block_send_eth(cpu_in[0]);
    //     ring_block_send_eth(cpu_in[1]);
    //     ring_block_send_eth(cpu_in[2]);
    //     ring_block_send_eth(cpu_in[3]);
    //     ring_block_send_eth(cpu_in[4]);
    //     ring_block_send_eth(cpu_in[5]);
    //     ring_block_send_eth(cpu_in[1022]);
    //     ring_block_send_eth(cpu_in[1023]);
    //     ring_block_send_eth(cpu_in[1024+TRUNK_FRAME_COUNTER]);
    // } else {
    //     ring_block_send_eth(cpu_in[1024+TRUNK_FRAME_COUNTER]);
    // }

    // // const unsigned int* const cpu_ptr_from_dma = cpu_in;
    // // const unsigned int* const cpu_ptr_fft = cpu_out;

    const unsigned fft0_row_in = VMEM_ROW_ADDRESS(cpu_in);
    // const unsigned fft0_row_out = VMEM_ROW_ADDRESS(fft_mem_temp);


    // active_plan.data_location   = fft0_row_in;        //input
    // active_plan.data_location_0 = fft0_row_out;       //output

    // fft_1024_run(&active_plan);

    // ////////////////////////////////////////////////////////


    // // unsigned fft1_row_in = VMEM_ROW_ADDRESS(fft_mem_temp);
    // unsigned fft1_row_out = VMEM_ROW_ADDRESS(cpu_out);


    // active_plan_2.data_location   = fft0_row_out;        //input
    // active_plan_2.data_location_0 = fft1_row_out;       //output

    // fft_1024_run(&active_plan_2);


    // vmem_copy_rows(fft0_row_in, fft1_row_out, 1040 / 16);
    dma_block_send(VMEM_DMA_ADDRESS(cpu_in), 1);
    // if( 1 ) {
    //       unsigned int occupancy;
    //       while(1) {
    //         CSR_READ(DMA_1_SCHEDULE_OCCUPANCY, occupancy);
    //         if( occupancy == 0) {
    //           break;
    //         }
    //     }
    // }


    dma_block_send_reverse(VMEM_DMA_ADDRESS(cpu_in+1023), 1023);
    // if( 1 ) {
    //       unsigned int occupancy;
    //       while(1) {
    //         CSR_READ(DMA_1_SCHEDULE_OCCUPANCY, occupancy);
    //         if( occupancy == 0) {
    //           break;
    //         }
    //     }
    // }

    dma_block_send(VMEM_DMA_ADDRESS(cpu_in), 1);
    // if( 1 ) {
    //       unsigned int occupancy;
    //       while(1) {
    //         CSR_READ(DMA_1_SCHEDULE_OCCUPANCY, occupancy);
    //         if( occupancy == 0) {
    //           break;
    //         }
    //     }
    // }


    dma_block_send_reverse(VMEM_DMA_ADDRESS(cpu_in+1023), 1023);
    // if( 1 ) {
    //       unsigned int occupancy;
    //       while(1) {
    //         CSR_READ(DMA_1_SCHEDULE_OCCUPANCY, occupancy);
    //         if( occupancy == 0) {
    //           break;
    //         }
    //     }
    // }


    dma_block_send(VMEM_DMA_ADDRESS(cpu_in+1024), 16);
    if( 1 ) {
          unsigned int occupancy;
          while(1) {
            CSR_READ(DMA_1_SCHEDULE_OCCUPANCY, occupancy);
            if( occupancy == 0) {
              break;
            }
        }
    }



    if( 0 ) {

        const unsigned trunk_in_row  = VMEM_ROW_ADDRESS((cpu_in +TRUNK_OFFSET));
        const unsigned trunk_out_row = VMEM_ROW_ADDRESS((cpu_out+TRUNK_OFFSET));

        // copy trunk
        vmem_copy_rows(trunk_in_row, trunk_out_row, 1);
        STALL(50);
    }

    times_worked++;

    return 1;
}




void setup_barrel_shift(void) {
    variable_eq_rotate_row = VMEM_ROW_ADDRESS(variable_eq_rotate);
    variable_r0_mul_row    = VMEM_ROW_ADDRESS(variable_r0_mul);
    variable_r0_add_row    = VMEM_ROW_ADDRESS(variable_r0_add);
    variable_r1_mul_row    = VMEM_ROW_ADDRESS(variable_r1_mul);
    variable_r1_add_row    = VMEM_ROW_ADDRESS(variable_r1_add);
    variable_eq_applied_row= VMEM_ROW_ADDRESS(variable_eq_applied);
}

        // VMEM_ROW_ADDRESS(config_word_conj_eq_0f),
        // VMEM_ROW_ADDRESS(config_word_conj_eq_14),
        // VMEM_ROW_ADDRESS(config_word_add_rx4_00),

void app_barrel_shift_callback(const unsigned int data) {
    // APP_BARREL_SHIFT_CMD
    const unsigned int stage = ((data & 0x00FF0000) >> 16);
    const unsigned int shift = ((data & 0xffff));

    unsigned short* cpu_source;
    unsigned short* cpu_dest;

    // we need to set conj and non conj the same here
    switch(stage) {
        case 0:
            cpu_source = config_word_conj_eq_0f;
            cpu_dest   = variable_eq_rotate;
            break;
        case 1:
            cpu_source = config_word_conj_eq_14;
            cpu_dest   = variable_r0_mul;
            break;
        case 2:
            cpu_source = config_word_add_rx4_00;
            cpu_dest   = variable_r0_add;
            break;
        case 3:
            cpu_source = config_word_conj_eq_14;
            cpu_dest   = variable_r1_mul;
            break;
        case 4:
            cpu_source = config_word_add_rx4_00;
            cpu_dest   = variable_r1_add;
            break;

        case 5:
            cpu_source = config_word_conj_eq_0f;
            cpu_dest   = variable_eq_applied;
            break;

        default:
            return; // exit the function
            break;
    }

    copy_set_barrel(cpu_source, cpu_dest, shift);
}

void default_barrel_shift_callback(const unsigned int data) {
    (void)data;
    app_barrel_shift_callback(0x000000 | 0x0f);
    app_barrel_shift_callback(0x010000 | 0x12);
    app_barrel_shift_callback(0x020000 | 0x00);
    app_barrel_shift_callback(0x030000 | 0x12);
    app_barrel_shift_callback(0x040000 | 0x00);
    app_barrel_shift_callback(0x050000 | 0x08);
}


void got_ook_counter(const uint32_t ook_counter) {

    // our counter is this much behind of ota counter
    // thus, adding this value to our counter will fix
    // uint32_t our_behind = ook_counter - lifetime_32;

    // our counter is this much ahead of ota counter
    // thus, subtracting this value to our counter will fix
    uint32_t our_ahead = lifetime_32 - ook_counter - OOK_DELTA_FRAMES;

    fsm_notify_ook_counter(our_ahead);

    ring_block_send_eth_u32(RX_COUNTER_SYNC_PCCMD, our_ahead);

    // ring_block_send_eth( RX_COUNTER_SYNC_PCCMD | 0x00000 | (our_behind & 0x0000ffff)  );
    // ring_block_send_eth( RX_COUNTER_SYNC_PCCMD | 0x10000 | (our_behind>>16 & 0x0000ffff)  );
    
    // cout << HEX32_STRING(our_behind) << "\n";
    
    // uint32_t corrected = counter + our_behind;
    



}


void got_ook_message(const OOKMessage* const raw) {
    // // _printf("Got message 0x%x\n", message->data[0]);

    // const uint32_t word  =  raw->data[0];
    // const uint8_t  type  = (raw->data[1]     ) & 0xff;
    // const uint8_t  extra = (raw->data[1] >> 8) & 0xff;
    // (void)extra;

    // switch(type) {
    //     case FRAME_COUNTER_OOK:
    //         got_ook_counter(word);
    //         break;
    // }
    // // ring_block_send_eth(raw->data[0]);
}



uint32_t* pointer_for_generic_op(const uint32_t sel) {
    uint32_t *p = 0;
    switch(sel) {
        case 0:
            p = &lifetime_32;
            break;
        case 1:
            p = &demod.state;
            break;
        case 2:
            // most significant
            p = ((uint32_t*)&demod.off_filter_state) + 1;
            break;
        case 3:
            // least significant
            p = (uint32_t*)&demod.off_filter_state;
            break;
        case 4:
            // most significant
            p = ((uint32_t*)&demod.on_filter_state) + 1;
            break;
        case 5:
            // least significant
            p = (uint32_t*)&demod.on_filter_state;
            break;
        case 6:
            p = &demod.filter_gain_off;
            break;
        case 7:
            p = &demod.filter_gain_on;
            break;
        case 8:
            p = &duplex_state;
            break;
        // case 9:
        //     p = &debug_ota_sc;
        //     break;
        case 10:
            p = (uint32_t*) &duplex.role;
            break;
        case 11:
            p = (uint32_t*) &duplex_mode_rx;
            break;
        case 12:
            p = (uint32_t*) &EQ_data_rx_indi;
            break;
        case 13:
            p = (uint32_t*) &sfo_correction_rx_flag;
            break;
        case 14:
            p = (uint32_t*) &dnr_extra;
            break;
        default:
            break;
    }
    return p;
}

void generic_op_finished(const uint32_t sel, const uint32_t op, const uint32_t value ) {
    (void)op;
    (void)value;
    switch(sel) {
        case 10:
            update_duplex_role(&duplex);
            break;
    }
}



void set_ook_sc_callback(const unsigned int data) {
    if( data < 1024 ) {
        ook_subcarrier = data;
    } else {
        // error, do nothing
    }
}

void sync_callback_duplex(const unsigned int data) {
    (void)data;
    fsm_notify_coarse_sync();
}


void debug_ota_frame_callback(const unsigned int data) {
    do_debug_ota_frame = data;
}

void setup_duplex(void) {
    init_duplex(&duplex, DUPLEX_ROLE_TX_0);
    init_duplex(&duplex_rx, DUPLEX_ROLE_RX);
}


void sfo_correction_rx_callback(const unsigned int data)
{
    sfo_correction_rx_flag = data;
    ring_block_send_eth(0x56780000|data);
}

void sfo_shift_rx_callback(const unsigned int data)
{
    sfo_shift_rx_amount = data;
}

void EQ_data_rx_callback(const unsigned int data)
{
    EQ_data_rx_indi = data;
    ring_block_send_eth(0x87650000|data);
}

void cooked_data_type_callback(const unsigned int data) {
    cooked_data_type = data;
}

void rx_eq_for_data_callback(const unsigned int data)
{
    rx_eq_for_data_flag = data;
}


void iir_coeff_state_rx_callback(const unsigned int data)
{
    unsigned int state_gain = data & 0xffff;
    
    if(state_gain > 0x7fff) {
        return;
    }

    unsigned int new_measure_gain = 0x7fff - state_gain;
    for(unsigned int index = 0; index < 16; index++)
    {
        rx_coeff_state_one_row[index] = state_gain;
        rx_coeff_new_measure_one_row[index] = new_measure_gain;
    }
}

void iir_coeff_state_tx_callback(const unsigned int data)
{
    unsigned int state_gain = data & 0xffff;
    
    if(state_gain > 0x7fff) {
        return;
    }

    unsigned int new_measure_gain = 0x7fff - state_gain;
    for(unsigned int index = 0; index < 16; index++)
    {
        tx_coeff_state_one_row[index] = state_gain;
        tx_coeff_new_measure_one_row[index] = new_measure_gain;
    }
}

void setup_pointers(void) {
    duplex_composite_ul_pilot_row = VMEM_ROW_ADDRESS(duplex_composite_ul_pilot);
    duplex_composite_ul_pilot_dma = VMEM_DMA_ADDRESS(duplex_composite_ul_pilot);
    garbage_row = VMEM_ROW_ADDRESS(garbage_vmem);
}

// #define FFT_STAGES (5)

/*
void fft_barrel_shift_defaults(void) {

    // unsigned stage_wrap;
    // unsigned set_wrap;
    // fft1024_cfg_t* set_ptr;

    const unsigned default_shift[FFT_STAGES] = {
         0x10
        ,0x10
        ,0x10
        ,0x10
        ,0x10
        };

    for(unsigned i = 0; i < FFT_STAGES; i++ ) {


        fft_1024_set_bs(&active_plan  , i, default_shift[i%FFT_STAGES]);
        fft_1024_set_bs(&active_plan_2, i, default_shift[i%FFT_STAGES]);
    }

}

*/

int main2(void);
int main(void)
{
    self_sync_block_boot();
    main2();
    return 0;
}
int main2(void) {

    ping_pong_set_callback(&do_work);
    setup_ping_pong();


    // ring_register_callback(fine_sync_callback, SYNCHRONIZATION_CMD);
    ring_register_callback(&corrupt_dma_callback, CORRUPT_DMA_OUT_CMD);
    ring_register_callback(&check_bootload_status, CHECK_BOOTLOAD_CMD);
    ring_register_callback(&app_barrel_shift_callback, APP_BARREL_SHIFT_CMD);
    ring_register_callback(&default_barrel_shift_callback, DEFAULT_APP_BARREL_SHIFT_CMD);
    ring_register_callback(&readback_timer_callback, GET_TIMER_CMD);
    ring_register_callback(&handle_generic_callback_original, GENERIC_OPERATOR_CMD);
    ring_register_callback(&set_ook_sc_callback, SET_TDMA_SC_CMD);
    ring_register_callback(&sync_callback_duplex, DUPLEX_SYNCHRONIZATION_CMD);
    ring_register_callback(&debug_ota_frame_callback, DEBUG_OTA_FRAME_CMD);
    ring_register_callback(&sfo_correction_rx_callback, SFO_CORRECTION_RX_CMD);
    ring_register_callback(&sfo_shift_rx_callback, SFO_SHIFT_RX_CMD);
    ring_register_callback(&EQ_data_rx_callback, EQ_DATA_RX_CMD);
    ring_register_callback(&cooked_data_type_callback, COOKED_DATA_TYPE_CMD);
    ring_register_callback(&iir_coeff_state_rx_callback, IIR_COEFF_STATE_RX_CMD);
    ring_register_callback(&iir_coeff_state_tx_callback, IIR_COEFF_STATE_TX_CMD);

    ring_register_callback(&rx_eq_for_data_callback, RX_EQ_FOR_DATA_CMD);

    setup_duplex();

    setup_pointers();

    setup_fft();

    // fft_barrel_shift_defaults();











    ook_prep_demod(&demod);
    ook_register_callback(&got_ook_message);

    handle_generic_register_post_callback(&generic_op_finished);
    handle_generic_register_get_pointer(&pointer_for_generic_op);
    handle_generic_register_ring(&ring_block_send_eth);
  

  CSR_WRITE(GPIO_WRITE_EN, 0xffffffff);

  //xbb_coarse_sync(15);

  setup_barrel_shift();
  default_barrel_shift_callback(0);


  CSR_WRITE(GPIO_WRITE, 0xdeadbeef);

  // ring_block_send_eth(0xdead);
  // ring_block_send_eth(VMEM_ROW_ADDRESS(dma_buffer_a));
  // ring_block_send_eth(VMEM_ROW_ADDRESS(dma_buffer_b));

  // ring_block_send_eth(dma_in_ptr[0]);
  // ring_block_send_eth(dma_in_ptr[1]);
  // ring_block_send_eth(fft_ptr[0]);
  // ring_block_send_eth(fft_ptr[1]);

  Ringbus ringbus;

  while(1) {
    execute_ping_pong();
      check_ring(&ringbus);
  }
  return 0;
}



